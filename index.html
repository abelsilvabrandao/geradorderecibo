<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
  <title>Gerador de Recibo</title>
  <style>
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 150px;
    }

    :root {
    --primary-color: #4CAF50;
    --text-color: #333;
    --background-color: #f0f0f0;
    --card-background: #fff;
}
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    padding: 20px;
}
    
    h1 {
      text-align: center;
      color: #4CAF50;
    }
    .recibo {
      width: 300px;
      padding: 20px;
      background: white;
      border: 1px solid #ccc;
      margin-top: 20px;
      position: relative;
    }
    .campo {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      padding: 5px;
      border-radius: 8px;
      font-size: 1rem;
    }

    input[type="text"], input[type="date"] {
      border: 1px solid #ccc;
    }
    input[type="text"]:focus, input[type="date"]:focus {
      border-color: #4CAF50;
      outline: none;
    }

    button {
    background-color: #4CAF50;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    width: 100%;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-top: 20px;
}

button:hover {
    background-color: #45a049;
}
    canvas {
      display: none;
    }
    #botoes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    #recibo {
    display: none;
    position: relative;
  letter-spacing: 0;
  word-spacing: 0.2px;
}
#recibo .assinatura {
  margin: 2px 0;
  font-size: 12px;
  text-align: center;
}
  </style>
</head>
<body>
  <img src="logo.png" alt="Logo" class="logo">
  <h1>GERADOR DE RECIBO</h1>

  <div class="campo">
    <label for="tipoPessoa">Tipo de Cliente:</label>
    <select id="tipoPessoa" onchange="alternarDocumento()">
      <option value="cpf">Pessoa Física</option>
      <option value="cnpj">Pessoa Jurídica</option>
    </select>
  </div>

  <div class="campo">
    <label for="nome_emitente">Emitente (quem assina):</label>
    <input type="text" id="nome_emitente" placeholder="Nome do Emitente">
  </div>

  <div class="campo">
    <label for="cpf_emitente">CPF do Emitente:</label>
    <input type="text" id="cpf_emitente" placeholder="CPF do Emitente">
  </div>

  <div class="campo">
    <label for="nome_cliente">Nome/Razão Social do Cliente:</label>
    <input type="text" id="nome_cliente" placeholder="Nome do Cliente">
  </div>

  <div class="campo" id="campo_doc_cliente">
    <label for="doc_cliente">CPF/CNPJ do Cliente:</label>
    <input type="text" id="doc_cliente" placeholder="CPF ou CNPJ">
  </div>

  <div class="campo">
    <label for="valor">Valor (R$):</label>
    <input type="text" id="valor" placeholder="70,00">
  </div>

  <div class="campo">
    <label for="extenso">Valor por extenso:</label>
    <input type="text" id="extenso" placeholder="Setenta reais">
  </div>

  <div class="campo">
    <label for="descricao">Descrição:</label>
    <textarea id="descricao" placeholder="aquisição de 07 (sete) cabaças de cacau"></textarea>
  </div>

  <div class="campo">
    <label for="local">Local:</label>
    <input type="text" id="local" placeholder="Banco da vitória, Ilhéus-Ba">
  </div>

  <div class="campo">
    <label for="data">Data:</label>
    <input type="date" id="data">
  </div>

  <div class="campo">
    <label for="assinatura">Assinatura (Opcional):</label>
    <input type="file" id="assinatura" accept="image/png">
  </div>

  <div id="botoes">
    <button onclick="gerarRecibo()">Gerar Recibo</button>
    <button id="btnDownload" onclick="baixarImagem()" style="display: none;">Baixar Imagem</button>
    <button id="btnCompartilhar" onclick="compartilharPDF()" style="display: none;">Compartilhar PDF</button>
  </div>

  <div id="recibo" class="recibo"></div>
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    let assinaturaDataUrl = null;

    document.getElementById('assinatura').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file && file.type === 'image/png') {
        const reader = new FileReader();
        reader.onload = function(e) {
          assinaturaDataUrl = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    function alternarDocumento() {
    const tipo = document.getElementById('tipoPessoa').value;

  // Atualiza o campo de documento
    const labelDoc = document.querySelector("label[for='doc_cliente']");
    labelDoc.textContent = tipo === 'cpf' ? 'CPF do Cliente:' : 'CNPJ do Cliente:';

  // Atualiza o campo de nome/razão social
    const labelNome = document.querySelector("label[for='nome_cliente']");
    labelNome.textContent = tipo === 'cpf' ? 'Nome do Cliente:' : 'Razão Social do Cliente:';
    }

    document.getElementById('doc_cliente').addEventListener('input', function () {
    const tipo = document.getElementById('tipoPessoa').value;
    let valor = this.value.replace(/\D/g, '');

    if (tipo === 'cpf') {
    valor = valor.slice(0, 11)
      .replace(/(\d{3})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    } else {
    valor = valor.slice(0, 14)
      .replace(/(\d{2})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d)/, '$1/$2')
      .replace(/(\d{4})(\d{1,2})$/, '$1-$2');
    }

  this.value = valor;
  });

  function gerarRecibo() {
  const tipo = document.getElementById('tipoPessoa').value; // <- necessário aqui!

  const emitente = document.getElementById('nome_emitente').value.trim();
  const cpf_emitente = document.getElementById('cpf_emitente').value.trim();
  const cliente = document.getElementById('nome_cliente').value.trim();
  const doc_cliente = document.getElementById('doc_cliente').value.trim();
  const valor = document.getElementById('valor').value.trim();
  const extenso = document.getElementById('extenso').value.trim();
  const descricao = document.getElementById('descricao').value.trim();
  const local = document.getElementById('local').value.trim();
  const data = document.getElementById('data').value;

  // validação dos campos obrigatórios
  if (!emitente || !cpf_emitente || !cliente || !doc_cliente || !valor || !extenso || !descricao || !local || !data) {
    alert('Por favor, preencha todos os campos obrigatórios.');
    return;
  }


  const recibo = document.getElementById('recibo');
recibo.innerHTML = `
  <h2>RECIBO</h2>
  <p>Eu , <strong>${emitente}</strong> inscrito no CPF ${cpf_emitente} , declaro que recebi de <strong>${cliente}</strong> inscrito(a) no ${tipo === 'cpf' ? 'CPF nº' : 'CNPJ nº'} ${doc_cliente} a importância de R$${valor}. (${extenso}), referente ao pagamento correspondente à ${descricao}.</p>
  <br>
  <p>${local}, ${formataData(data)}.</p>
  <br><br>
  ${assinaturaDataUrl ? `<img src="${assinaturaDataUrl}" alt="Assinatura" style="max-width: 100%; height: 50px;"><br>` : ''}
  <p class="assinatura">____________________________</p>
  <p class="assinatura">${emitente}</p>
  <p class="assinatura">CPF: ${cpf_emitente}</p>
`;

  // Torna o recibo visível após gerado
  recibo.style.display = 'block';
  recibo.style.position = 'relative';

  setTimeout(() => {
    gerarImagemDoRecibo();
    document.getElementById('btnDownload').style.display = 'inline-block';
    document.getElementById('btnCompartilhar').style.display = 'inline-block';
  }, 100);
}
function gerarImagemDoRecibo() {
   html2canvas(document.getElementById('recibo'), { scale: 2 }).then(canvas => {
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const downloadLink = document.createElement('a');
      downloadLink.href = url;
      downloadLink.download = 'recibo.png';
      document.getElementById('btnDownload').onclick = () => downloadLink.click();
    });
  });
}
function baixarImagem() {
  // esse clique será acionado dinamicamente após gerarRecibo()
}

    async function compartilharPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      const recibo = document.getElementById('recibo');
      const canvas = await html2canvas(recibo, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const imgProps = doc.getImageProperties(imgData);

      const pdfWidth = pageWidth - 40;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      const marginTop = 20;

      doc.addImage(imgData, 'PNG', 20, marginTop, pdfWidth, pdfHeight);

      const blob = doc.output('blob');
      const file = new File([blob], 'recibo.pdf', { type: 'application/pdf' });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: 'Recibo', text: 'Confira o recibo gerado.' });
        } catch (err) {
          alert('Compartilhamento cancelado ou não suportado.');
        }
      } else {
        alert('Este navegador não suporta compartilhamento de arquivos.');
      }
    }

    function formataData(dataISO) {
  const [ano, mes, dia] = dataISO.split('-');
  const meses = [
    'janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
    'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
  ];
  return `${dia} de ${meses[parseInt(mes, 10) - 1]} de ${ano}`;
}
  </script>
</body>
</html>
