<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4CAF50" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
  <title>Gerador de Recibo</title>
  <style>
    .logo {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 150px;
    }

    :root {
      --primary-color: #4CAF50;
      --text-color: #333;
      --background-color: #f0f0f0;
      --card-background: #fff;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
        Cantarell, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #4CAF50;
    }
    .recibo {
      width: 300px;
      padding: 20px;
      background: white;
      border: 1px solid #ccc;
      margin-top: 20px;
      position: relative;
    }
    .campo {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
    }
    input,
    textarea,
    select {
      width: 100%;
      padding: 5px;
      border-radius: 8px;
      font-size: 1rem;
    }

    input[type='text'],
    input[type='date'] {
      border: 1px solid #ccc;
    }
    input[type='text']:focus,
    input[type='date']:focus {
      border-color: #4CAF50;
      outline: none;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-top: 20px;
    }

    button:hover {
      background-color: #45a049;
    }
    canvas {
      display: none;
    }
    #botoes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    #recibo {
      display: none;
      position: relative;
      letter-spacing: 0;
      word-spacing: 0.2px;
    }
    #recibo .assinatura {
      margin: 2px 0;
      font-size: 12px;
      text-align: center;
    }

    /* Login screen styles */
    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #login-screen.hidden {
      display: none;
    }
    #login-screen h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }
    #login-screen input {
      margin-bottom: 10px;
      width: 250px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #login-screen button {
      width: 260px;
    }
    #error-message {
      color: red;
      margin-bottom: 10px;
      height: 18px;
    }

    /* Receipt query screen */
    #query-screen {
      display: none;
      margin-top: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    #query-screen h2 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    #query-screen .campo {
      margin-bottom: 10px;
    }
    #query-results {
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    #query-results .result-item {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }
    #query-results .result-item:last-child {
      border-bottom: none;
    }
    #logout-button {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #e53935;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      z-index: 1100;
    }
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      GoogleAuthProvider,
      signInWithPopup,
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      where,
      getDocs,
      orderBy,
      limit,
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAZsIso9U5xe4RLAbLuSWZb1Vufck_1ULo",
      authDomain: "geradorderecibo-e7339.firebaseapp.com",
      projectId: "geradorderecibo-e7339",
      storageBucket: "geradorderecibo-e7339.firebasestorage.app",
      messagingSenderId: "567493290213",
      appId: "1:567493290213:web:a1954f722436ff92bbcc0c",
      measurementId: "G-PF5JYYKDHP",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const loginScreen = document.getElementById("login-screen");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginButton = document.getElementById("login-button");
    const googleLoginButton = document.getElementById("google-login-button");
    const errorMessage = document.getElementById("error-message");
    const mainContent = document.getElementById("main-content");
    const queryScreen = document.getElementById("query-screen");
    const queryButton = document.getElementById("open-query-button");
    const logoutButton = document.getElementById("logout-button");

    // Show or hide main content and login screen based on auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginScreen.classList.add("hidden");
        mainContent.style.display = "block";
        logoutButton.style.display = "block";
      } else {
        loginScreen.classList.remove("hidden");
        mainContent.style.display = "none";
        logoutButton.style.display = "none";
        emailInput.value = "";
        passwordInput.value = "";
        errorMessage.textContent = "";
      }
    });

    // Email/password login
    loginButton.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      errorMessage.textContent = "";
      if (!email || !password) {
        errorMessage.textContent = "Por favor, preencha email e senha.";
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        errorMessage.textContent = "Erro ao fazer login: " + error.message;
      }
    });

    // Google login
    googleLoginButton.addEventListener("click", async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        errorMessage.textContent = "Erro ao fazer login com Google: " + error.message;
      }
    });

    // Logout
    logoutButton.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Save receipt to Firestore
    async function saveReceipt(receiptData) {
      try {
        await addDoc(collection(db, "recibos"), receiptData);
      } catch (error) {
        alert("Erro ao salvar recibo: " + error.message);
      }
    }

    // Query receipts by filters
    async function queryReceipts(filters) {
      let q = collection(db, "recibos");
      const conditions = [];

      if (filters.nome_cliente) {
        conditions.push(where("nome_cliente", "==", filters.nome_cliente));
      }
      if (filters.doc_cliente) {
        conditions.push(where("doc_cliente", "==", filters.doc_cliente));
      }
      if (filters.data) {
        conditions.push(where("data", "==", filters.data));
      }

      if (conditions.length > 0) {
        q = query(q, ...conditions, orderBy("data", "desc"), limit(50));
      } else {
        q = query(q, orderBy("data", "desc"), limit(50));
      }

      const querySnapshot = await getDocs(q);
      return querySnapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
    }

    // Receipt generation and other functions moved inside module script for scope access

    let assinaturaDataUrl = null;

    document.getElementById("assinatura").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file && file.type === "image/png") {
        const reader = new FileReader();
        reader.onload = function (e) {
          assinaturaDataUrl = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    function alternarDocumento() {
      const tipo = document.getElementById("tipoPessoa").value;

      // Atualiza o campo de documento
      const labelDoc = document.querySelector("label[for='doc_cliente']");
      labelDoc.textContent = tipo === "cpf" ? "CPF do Cliente:" : "CNPJ do Cliente:";

      // Atualiza o campo de nome/razão social
      const labelNome = document.querySelector("label[for='nome_cliente']");
      labelNome.textContent = tipo === "cpf" ? "Nome do Cliente:" : "Razão Social do Cliente:";
    }

    document.getElementById("doc_cliente").addEventListener("input", function () {
      const tipo = document.getElementById("tipoPessoa").value;
      let valor = this.value.replace(/\D/g, "");

      if (tipo === "cpf") {
        valor = valor
          .slice(0, 11)
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      } else {
        valor = valor
          .slice(0, 14)
          .replace(/(\d{2})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1/$2")
          .replace(/(\d{4})(\d{1,2})$/, "$1-$2");
      }

      this.value = valor;
    });

    document.getElementById("cpf_emitente").addEventListener("input", function () {
      let valor = this.value.replace(/\D/g, "");
      valor = valor
        .slice(0, 11)
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      this.value = valor;
    });

    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, "");
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf.charAt(10));
    }

    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/[^\d]+/g, "");
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0;
      let pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
        if (pos < 2) pos = 9;
      }
      let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      if (resultado !== parseInt(digitos.charAt(0))) return false;
      tamanho += 1;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
        if (pos < 2) pos = 9;
      }
      resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      return resultado === parseInt(digitos.charAt(1));
    }

    async function gerarRecibo() {
      const tipo = document.getElementById("tipoPessoa").value; // <- necessário aqui!

      const emitente = document.getElementById("nome_emitente").value.trim();
      const cpf_emitente = document.getElementById("cpf_emitente").value.trim();
      const cliente = document.getElementById("nome_cliente").value.trim();
      const doc_cliente = document.getElementById("doc_cliente").value.trim();
      const valor = document.getElementById("valor").value.trim();
      const extenso = document.getElementById("extenso").value.trim();
      const descricao = document.getElementById("descricao").value.trim();
      const local = document.getElementById("local").value.trim();
      const data = document.getElementById("data").value;

      // validação dos campos obrigatórios
      if (
        !emitente ||
        !cpf_emitente ||
        !cliente ||
        !doc_cliente ||
        !valor ||
        !extenso ||
        !descricao ||
        !local ||
        !data
      ) {
        alert("Por favor, preencha todos os campos obrigatórios.");
        return;
      }

      // Save receipt to Firestore with error handling
      const receiptData = {
        tipo,
        emitente,
        cpf_emitente,
        nome_cliente: cliente,
        doc_cliente,
        valor,
        extenso,
        descricao,
        local,
        data,
        timestamp: new Date().toISOString(),
      };
      try {
        await saveReceipt(receiptData);
      } catch (error) {
        alert("Erro ao salvar recibo: " + error.message);
      }

      const recibo = document.getElementById("recibo");
      recibo.innerHTML = `
        <h2>RECIBO</h2>
        <p>Eu , <strong>${emitente}</strong> inscrito no CPF ${cpf_emitente} , declaro que recebi de <strong>${cliente}</strong> inscrito(a) no ${
        tipo === "cpf" ? "CPF nº" : "CNPJ nº"
      } ${doc_cliente} a importância de R$${valor}. (${extenso}), referente ao pagamento correspondente à ${descricao}.</p>
        <br>
        <p>${local}, ${formataData(data)}.</p>
        <br><br>
        ${
          assinaturaDataUrl
            ? `<img src="${assinaturaDataUrl}" alt="Assinatura" style="max-width: 100%; height: 50px;"><br>`
            : ""
        }
        <p class="assinatura">____________________________</p>
        <p class="assinatura">${emitente}</p>
        <p class="assinatura">CPF: ${cpf_emitente}</p>
      `;

      // Torna o recibo visível após gerado
      recibo.style.display = "block";
      recibo.style.position = "relative";

      setTimeout(() => {
        gerarImagemDoRecibo();
        document.getElementById("btnDownload").style.display = "inline-block";
        document.getElementById("btnCompartilhar").style.display = "inline-block";
      }, 100);
    }

    function gerarImagemDoRecibo() {
      html2canvas(document.getElementById("recibo"), { scale: 2 }).then((canvas) => {
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const downloadLink = document.createElement("a");
          downloadLink.href = url;
          downloadLink.download = "recibo.png";
          document.getElementById("btnDownload").onclick = () => downloadLink.click();
        });
      });
    }
    function baixarImagem() {
      // esse clique será acionado dinamicamente após gerarRecibo()
    }

    async function compartilharPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      const recibo = document.getElementById("recibo");
      const canvas = await html2canvas(recibo, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const imgProps = doc.getImageProperties(imgData);

      const pdfWidth = pageWidth - 40;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      const marginTop = 20;

      doc.addImage(imgData, "PNG", 20, marginTop, pdfWidth, pdfHeight);

      const blob = doc.output("blob");
      const file = new File([blob], "recibo.pdf", { type: "application/pdf" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: "Recibo", text: "Confira o recibo gerado." });
        } catch (err) {
          alert("Compartilhamento cancelado ou não suportado.");
        }
      } else {
        alert("Este navegador não suporta compartilhamento de arquivos.");
      }
    }

    function formataData(dataISO) {
      const [ano, mes, dia] = dataISO.split("-");
      const meses = [
        "janeiro",
        "fevereiro",
        "março",
        "abril",
        "maio",
        "junho",
        "julho",
        "agosto",
        "setembro",
        "outubro",
        "novembro",
        "dezembro",
      ];
      return `${dia} de ${meses[parseInt(mes, 10) - 1]} de ${ano}`;
    }

    // Toggle receipt query screen visibility
    function toggleQueryScreen() {
      const queryScreen = document.getElementById("query-screen");
      if (queryScreen.style.display === "none" || queryScreen.style.display === "") {
        queryScreen.style.display = "block";
      } else {
        queryScreen.style.display = "none";
      }
    }

    // Consult receipts from Firestore based on filters
    async function consultarRecibos() {
      const nome = document.getElementById("query-nome").value.trim();
      const doc = document.getElementById("query-doc").value.trim();
      const data = document.getElementById("query-data").value;

      const filters = {};
      if (nome) filters.nome_cliente = nome;
      if (doc) filters.doc_cliente = doc;
      if (data) filters.data = data;

      const results = await queryReceipts(filters);
      const resultsContainer = document.getElementById("query-results");
      resultsContainer.innerHTML = "";

      if (results.length === 0) {
        resultsContainer.textContent = "Nenhum recibo encontrado.";
        return;
      }

      results.forEach((recibo) => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `
          <strong>Cliente:</strong> ${recibo.nome_cliente} <br />
          <strong>Documento:</strong> ${recibo.doc_cliente} <br />
          <strong>Data:</strong> ${formataData(recibo.data)} <br />
          <strong>Valor:</strong> R$${recibo.valor} <br />
          <strong>Descrição:</strong> ${recibo.descricao}
        `;
        resultsContainer.appendChild(div);
      });
    }
  </script>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen">
    <h2>Login</h2>
    <div id="error-message"></div>
    <input type="email" id="email" placeholder="Email" autocomplete="username" />
    <input type="password" id="password" placeholder="Senha" autocomplete="current-password" />
    <button id="login-button">Entrar</button>
    <button id="google-login-button">Entrar com Google</button>
  </div>

  <!-- Logout Button -->
  <button id="logout-button" style="display:none;">Sair</button>

  <!-- Main Content -->
  <div id="main-content" style="display:none;">
    <img src="logo.png" alt="Logo" class="logo" />
    <h1>GERADOR DE RECIBO</h1>

    <div class="campo">
      <label for="tipoPessoa">Tipo de Cliente:</label>
      <select id="tipoPessoa" onchange="alternarDocumento()">
        <option value="cpf">Pessoa Física</option>
        <option value="cnpj">Pessoa Jurídica</option>
      </select>
    </div>

    <div class="campo">
      <label for="nome_emitente">Emitente (quem assina):</label>
      <input type="text" id="nome_emitente" placeholder="Nome do Emitente" />
    </div>

    <div class="campo">
      <label for="cpf_emitente">CPF do Emitente:</label>
      <input type="text" id="cpf_emitente" placeholder="CPF do Emitente" />
    </div>

    <div class="campo">
      <label for="nome_cliente">Nome/Razão Social do Cliente:</label>
      <input type="text" id="nome_cliente" placeholder="Nome do Cliente" />
    </div>

    <div class="campo" id="campo_doc_cliente">
      <label for="doc_cliente">CPF/CNPJ do Cliente:</label>
      <input type="text" id="doc_cliente" placeholder="CPF ou CNPJ do cliente" />
      <span id="erro_doc_cliente" style="color: red; font-size: 12px;"></span>
    </div>

    <div class="campo">
      <label for="valor">Valor (R$):</label>
      <input type="text" id="valor" placeholder="70,00" />
    </div>

    <div class="campo">
      <label for="extenso">Valor por extenso:</label>
      <input type="text" id="extenso" placeholder="Setenta reais" />
    </div>

    <div class="campo">
      <label for="descricao">Descrição:</label>
      <textarea id="descricao" placeholder="aquisição de 07 (sete) cabaças de cacau"></textarea>
    </div>

    <div class="campo">
      <label for="local">Local:</label>
      <input type="text" id="local" placeholder="Banco da vitória, Ilhéus-Ba" />
    </div>

    <div class="campo">
      <label for="data">Data:</label>
      <input type="date" id="data" />
    </div>

    <div class="campo">
      <label for="assinatura">Assinatura (Opcional):</label>
      <input type="file" id="assinatura" accept="image/png" />
    </div>

    <div id="botoes">
      <button onclick="gerarRecibo()">Gerar Recibo</button>
      <button id="btnDownload" onclick="baixarImagem()" style="display: none;">Baixar Imagem</button>
      <button id="btnCompartilhar" onclick="compartilharPDF()" style="display: none;">Compartilhar PDF</button>
      <button id="open-query-button" onclick="toggleQueryScreen()">Consultar Recibos</button>
    </div>

    <div id="recibo" class="recibo"></div>
    <canvas id="canvas"></canvas>

    <!-- Receipt Query Screen -->
    <div id="query-screen">
      <h2>Consulta de Recibos</h2>
      <div class="campo">
        <label for="query-nome">Nome do Cliente:</label>
        <input type="text" id="query-nome" placeholder="Nome do Cliente" />
      </div>
      <div class="campo">
        <label for="query-doc">CPF ou CNPJ do Cliente:</label>
        <input type="text" id="query-doc" placeholder="CPF ou CNPJ" />
      </div>
      <div class="campo">
        <label for="query-data">Data:</label>
        <input type="date" id="query-data" />
      </div>
      <button onclick="consultarRecibos()">Buscar</button>
      <div id="query-results"></div>
    </div>
  </div>


  <script>
    // Removed duplicate declaration of assinaturaDataUrl and related event listener and functions
    // These are now inside the module script for proper scope access

    function alternarDocumento() {
      const tipo = document.getElementById("tipoPessoa").value;

      // Atualiza o campo de documento
      const labelDoc = document.querySelector("label[for='doc_cliente']");
      labelDoc.textContent = tipo === "cpf" ? "CPF do Cliente:" : "CNPJ do Cliente:";

      // Atualiza o campo de nome/razão social
      const labelNome = document.querySelector("label[for='nome_cliente']");
      labelNome.textContent = tipo === "cpf" ? "Nome do Cliente:" : "Razão Social do Cliente:";
    }

    document.getElementById("doc_cliente").addEventListener("input", function () {
      const tipo = document.getElementById("tipoPessoa").value;
      let valor = this.value.replace(/\D/g, "");

      if (tipo === "cpf") {
        valor = valor
          .slice(0, 11)
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      } else {
        valor = valor
          .slice(0, 14)
          .replace(/(\d{2})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1.$2")
          .replace(/(\d{3})(\d)/, "$1/$2")
          .replace(/(\d{4})(\d{1,2})$/, "$1-$2");
      }

      this.value = valor;
    });

    document.getElementById("cpf_emitente").addEventListener("input", function () {
      let valor = this.value.replace(/\D/g, "");
      valor = valor
        .slice(0, 11)
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      this.value = valor;
    });

    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, "");
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf.charAt(10));
    }

    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/[^\d]+/g, "");
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
      let tamanho = cnpj.length - 2;
      let numeros = cnpj.substring(0, tamanho);
      let digitos = cnpj.substring(tamanho);
      let soma = 0;
      let pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
        if (pos < 2) pos = 9;
      }
      let resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      if (resultado !== parseInt(digitos.charAt(0))) return false;
      tamanho += 1;
      numeros = cnpj.substring(0, tamanho);
      soma = 0;
      pos = tamanho - 7;
      for (let i = tamanho; i >= 1; i--) {
        soma += parseInt(numeros.charAt(tamanho - i)) * pos--;
        if (pos < 2) pos = 9;
      }
      resultado = soma % 11 < 2 ? 0 : 11 - (soma % 11);
      return resultado === parseInt(digitos.charAt(1));
    }

    async function gerarRecibo() {
      const tipo = document.getElementById("tipoPessoa").value; // <- necessário aqui!

      const emitente = document.getElementById("nome_emitente").value.trim();
      const cpf_emitente = document.getElementById("cpf_emitente").value.trim();
      const cliente = document.getElementById("nome_cliente").value.trim();
      const doc_cliente = document.getElementById("doc_cliente").value.trim();
      const valor = document.getElementById("valor").value.trim();
      const extenso = document.getElementById("extenso").value.trim();
      const descricao = document.getElementById("descricao").value.trim();
      const local = document.getElementById("local").value.trim();
      const data = document.getElementById("data").value;

      // validação dos campos obrigatórios
      if (
        !emitente ||
        !cpf_emitente ||
        !cliente ||
        !doc_cliente ||
        !valor ||
        !extenso ||
        !descricao ||
        !local ||
        !data
      ) {
        alert("Por favor, preencha todos os campos obrigatórios.");
        return;
      }

      // Save receipt to Firestore with error handling
      const receiptData = {
        tipo,
        emitente,
        cpf_emitente,
        nome_cliente: cliente,
        doc_cliente,
        valor,
        extenso,
        descricao,
        local,
        data,
        timestamp: new Date().toISOString(),
      };
      try {
        await saveReceipt(receiptData);
      } catch (error) {
        alert("Erro ao salvar recibo: " + error.message);
      }

      const recibo = document.getElementById("recibo");
      recibo.innerHTML = `
        <h2>RECIBO</h2>
        <p>Eu , <strong>${emitente}</strong> inscrito no CPF ${cpf_emitente} , declaro que recebi de <strong>${cliente}</strong> inscrito(a) no ${
        tipo === "cpf" ? "CPF nº" : "CNPJ nº"
      } ${doc_cliente} a importância de R$${valor}. (${extenso}), referente ao pagamento correspondente à ${descricao}.</p>
        <br>
        <p>${local}, ${formataData(data)}.</p>
        <br><br>
        ${
          assinaturaDataUrl
            ? `<img src="${assinaturaDataUrl}" alt="Assinatura" style="max-width: 100%; height: 50px;"><br>`
            : ""
        }
        <p class="assinatura">____________________________</p>
        <p class="assinatura">${emitente}</p>
        <p class="assinatura">CPF: ${cpf_emitente}</p>
      `;

      // Torna o recibo visível após gerado
      recibo.style.display = "block";
      recibo.style.position = "relative";

      setTimeout(() => {
        gerarImagemDoRecibo();
        document.getElementById("btnDownload").style.display = "inline-block";
        document.getElementById("btnCompartilhar").style.display = "inline-block";
      }, 100);
    }

    function gerarImagemDoRecibo() {
      html2canvas(document.getElementById("recibo"), { scale: 2 }).then((canvas) => {
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const downloadLink = document.createElement("a");
          downloadLink.href = url;
          downloadLink.download = "recibo.png";
          document.getElementById("btnDownload").onclick = () => downloadLink.click();
        });
      });
    }
    function baixarImagem() {
      // esse clique será acionado dinamicamente após gerarRecibo()
    }

    async function compartilharPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });

      const recibo = document.getElementById("recibo");
      const canvas = await html2canvas(recibo, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const imgProps = doc.getImageProperties(imgData);

      const pdfWidth = pageWidth - 40;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      const marginTop = 20;

      doc.addImage(imgData, "PNG", 20, marginTop, pdfWidth, pdfHeight);

      const blob = doc.output("blob");
      const file = new File([blob], "recibo.pdf", { type: "application/pdf" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: "Recibo", text: "Confira o recibo gerado." });
        } catch (err) {
          alert("Compartilhamento cancelado ou não suportado.");
        }
      } else {
        alert("Este navegador não suporta compartilhamento de arquivos.");
      }
    }

    function formataData(dataISO) {
      const [ano, mes, dia] = dataISO.split("-");
      const meses = [
        "janeiro",
        "fevereiro",
        "março",
        "abril",
        "maio",
        "junho",
        "julho",
        "agosto",
        "setembro",
        "outubro",
        "novembro",
        "dezembro",
      ];
      return `${dia} de ${meses[parseInt(mes, 10) - 1]} de ${ano}`;
    }

    // Toggle receipt query screen visibility
    function toggleQueryScreen() {
      const queryScreen = document.getElementById("query-screen");
      if (queryScreen.style.display === "none" || queryScreen.style.display === "") {
        queryScreen.style.display = "block";
      } else {
        queryScreen.style.display = "none";
      }
    }

    // Consult receipts from Firestore based on filters
    async function consultarRecibos() {
      const nome = document.getElementById("query-nome").value.trim();
      const doc = document.getElementById("query-doc").value.trim();
      const data = document.getElementById("query-data").value;

      const filters = {};
      if (nome) filters.nome_cliente = nome;
      if (doc) filters.doc_cliente = doc;
      if (data) filters.data = data;

      const results = await queryReceipts(filters);
      const resultsContainer = document.getElementById("query-results");
      resultsContainer.innerHTML = "";

      if (results.length === 0) {
        resultsContainer.textContent = "Nenhum recibo encontrado.";
        return;
      }

      results.forEach((recibo) => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerHTML = `
          <strong>Cliente:</strong> ${recibo.nome_cliente} <br />
          <strong>Documento:</strong> ${recibo.doc_cliente} <br />
          <strong>Data:</strong> ${formataData(recibo.data)} <br />
          <strong>Valor:</strong> R$${recibo.valor} <br />
          <strong>Descrição:</strong> ${recibo.descricao}
        `;
        resultsContainer.appendChild(div);
      });
    }


  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
